<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <!-- jQuery -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
  <!-- iamport.payment.js -->
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
  <meta charset="UTF-8">
  <title>Sample Payment</title>
</head>
<body>

<h3 class="isbn">1111222233333</h3>
<h3 class="orderProductPrice">1000원</h3>

<h3 class="isbn">1111222244444</h3>
<h3 class="orderProductPrice">3000원</h3>


<button id="kakaoPay">결제하기</button>


<script th:inline="javascript">
  $(document).ready(function() {
    let IMP = window.IMP;
    IMP.init("imp20085076");

    let pg = "";
    let payMethod = "";
    let orders = [];
    let orderNumber = createOrderNum();

    $('#kakaoPay').on("click", function() { // 결제버튼 누르면
      pg = "kakaopay";
      payMethod = "card";
      createOrderList(); // 주문 목록 만드는 함수 호출
      requestPay();
    });

    function createOrderList() {

      $('.orderProductPrice').each(function(i, e) {
        let order = {};

        let price = parseInt($(e).text().replace(/[^0-9]/g, ''));

        if (!discountRate) {
          discountRate = 0;
        }

        order.productId = $(".td_wrap").eq(i).data("order-product-id");
        order.orderPrice = price - (price * (discountRate / 100));
        order.orderCount = parseInt($('.orderProductCount').eq(i).text().replace(/[^0-9]/g, ''));
        order.receiverName = $("#name").val();
        order.phoneNumber = $("#phone1").val();
        order.orderNumber = orderNumber;
        order.zipcode = parseInt($("#add").val());
        order.address = $("#add2").val();
        order.orderRequired = $("#ask").val();
        order.paymentMethod = payMethod;
        orders.push(order);
      });

      let order = {};
      let price = parseInt($(e).text().replace(/[^0-9]/g, ''));

    }

    function requestPay() {
      IMP.request_pay(
              {
                pg: "pg",
                pay_method: "card",
                merchant_uid: "20240401" + new Date().getTime(),
                name: "카카오페이 테스트결제",
                amount: 10,
                buyer_email: 'test@naver.com',
                buyer_name: '효진쓰',
                buyer_tel: '010-1234-5678',
                buyer_addr: '서울특별시',
                buyer_postcode: '123-456',
              },
              function (rsp) {
                console.log(rsp);
                $.ajax({
                  type: 'POST',
                  url: '/book/validation/' + rsp.imp_uid
                }).done(function (data) {
                  if (rsp.paid_amount === data.response.amount) {
                    alert("결제 성공");
                    // location.href = "결제 완료 후 이동할 페이지 url"
                  } else {
                    let msg = '결제에 실패하였습니다.';
                    msg += '에러내용 : ' + rsp.error_msg;
                    alert(msg);
                  }
                });
              });
    }


    // 주문번호 생성 함수
    function createOrderNum() {
      const date = new Date();
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");

      let orderNum = year + month + day;
      for (let i = 0; i < 5; i++) {
        orderNum += Math.floor(Math.random() * 8);
      }
      return parseInt(orderNum);
    }

  })
</script>
</body>
</html>