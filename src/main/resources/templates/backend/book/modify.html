<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{backend/layouts/base :: base(~{this::content})}">
  <th:block th:fragment="content">
    <div class="search_bar_wrap">
      <form action="" class="book_add_form" th:action th:object="${book}" method="post" enctype="multipart/form-data">
        <div class="search_date_wrap">
          <div class="item">
            <h2>상품수정</h2>
          </div>
          <div class="item">
            <button th:onclick="history.go(-1)" class="grey_btn">취소</button>
            <button type="submit" class="black_btn">저장</button>
          </div>
        </div>
        <div class="add_form_wrap">
          <div class="add_input_wrap" style="display:none;">
            <p>상품아이디</p>
            <input type="text" th:field="*{bookId}" readonly>
          </div>

          <div class="add_input_wrap">
            <p>카테고리명</p>
            <select th:field="*{bookCategory}">
              <option
                      th:each="ctlist : ${categoryLists}"
                      th:value="${ctlist.bookCategoryId}"
                      th:utext="${ctlist.bookCategoryName}"
              ></option>
            </select>
          </div>

          <div class="add_input_wrap">
            <p>ISBN</p>
            <input type="text" th:field="*{isbn}" placeholder="ISBN을 입력해주세요.">
          </div>

          <div class="add_input_wrap">
            <p>도서표지</p>
            <div id="drop_zone" class="drag_img_form" style="background-image:url();">
              <img id="image-preview" alt="" th:src="|/cms/bookimages/${book.getBookImgStored}|">
              <button type="button" class="img_delete_btn" onclick="clickdelete()"></button>
            </div>
            <span class="drop_zone_ph">수정하시려면 영역 안으로 이미지를 추가해주세요.</span>
            <input type="text" th:field="*{bookImgOrg}" class="image-input-form" placeholder="이미지를 첨부해주세요." readonly>
            <input type="text" id="bookImg" class="image-input-form" placeholder="이미지를 첨부해주세요." style="display:none;" readonly>

          </div>

          <div class="add_input_wrap">
            <p>도서명</p>
            <input type="text" th:field="*{bookTitle}" placeholder="도서명을 입력해주세요.">
          </div>
          <div class="add_input_wrap">
            <p>목차</p>
            <textarea th:field="*{bookIndex}" placeholder="목차를 입력해주세요."></textarea>
          </div>
          <div class="add_input_wrap">
            <p>도서소개</p>
            <textarea th:field="*{bookIntro}" placeholder="도서소개를 입력해주세요."></textarea>
          </div>
          <br>
          <div class="add_input_wrap">
            <p>저자</p>
            <input type="text" th:field="*{bookWriter}" placeholder="저자를 입력해주세요.">
          </div>
          <div class="add_input_wrap">
            <p>저자소개</p>
            <textarea th:field="*{bookWriterProfile}" placeholder="저자소개를 입력해주세요."></textarea>
          </div>
          <br>
          <div class="add_input_wrap">
            <p>출판사</p>
            <input type="text" th:field="*{bookPub}" placeholder="출판사를 입력해주세요.">
          </div>

          <div class="add_input_wrap">
            <p>서점명</p>
            <select th:field="*{store}">
              <option
                      th:each="stlist : ${storeLists}"
                      th:value="${stlist.storeId}"
                      th:utext="${stlist.storeTitle}"
              ></option>
            </select>
          </div>

          <div class="add_input_wrap">
            <p>독립서점 리뷰</p>
            <textarea th:field="*{bookReview}" placeholder="독립서점의 리뷰를 입력해주세요."></textarea>
          </div>
          <br>

          <div class="add_input_wrap">
            <p>책파일</p>
            <input type="text" class="BookFileName" th:value="${book.getBookFileOrg()}" placeholder="*PDF 파일만 첨부가 가능합니다." readonly>
            <input type="file" class="newBookFile" name="bookFiles" id="bookFiles" placeholder="*PDF 파일만 첨부가 가능합니다.">
            <span class="drop_zone_ph" style="transform:translateY(6px);">수정하시려면 새로운 파일을 추가해주세요.</span>
          </div>

          <div class="add_input_wrap">
            <p>전자도서 판매가</p>
            <input type="text" th:field="*{bookEbookPrice}" placeholder="전자도서 판매가를 입력해주세요.">
          </div>
          <div class="add_input_wrap">
            <p>일반도서 판매가</p>
            <input type="text" th:field="*{bookPaperPrice}" placeholder="일반도서 판매가를 입력해주세요.">
          </div>

          <div class="add_input_wrap">
            <p>수정일</p>
            <input type="text" th:field="*{lastModifiedDate}" id="lastModifiedDate" readonly>
          </div>
          <div class="add_input_wrap">
            <p>등록일</p>
            <input type="text" th:field="*{createDate}" id="createDate" readonly>
          </div>
          <div class="add_checkbox_wrap">
            <p>활성화</p>
            <input type="radio" th:field="*{bookStatus}" value="ON">활성화
            <input type="radio" th:field="*{bookStatus}" value="OFF">비활성화
          </div>
        </div>
      </form>
    </div>
  </th:block>
</th:block>
<script>
  let fileList = [];
  let files = null;

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    document.getElementById('drop_zone').addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults (e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    document.getElementById('drop_zone').addEventListener(eventName, highlight, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    document.getElementById('drop_zone').addEventListener(eventName, unhighlight, false);
  });

  function highlight(e) {
    document.getElementById('drop_zone').style.backgroundColor = '#fafafa';
  }

  function unhighlight(e) {
    document.getElementById('drop_zone').style.backgroundColor = '#dcdcdc';
  }

  document.getElementById('drop_zone').addEventListener('drop', handleDrop, false);

  function handleDrop(e) {
    let dt = e.dataTransfer;
    files = dt.files;

    handleFiles(files);
  }

  function handleFiles(files) {
    fileList = [...files]; // Update the fileList with the new set of files
    fileList.forEach(uploadFile);
  }

  function uploadFile(file) {
    document.getElementById('bookImgOrg').value = file.name;
    document.getElementById('bookImg').value = file.name;

    //이미지 미리보기
    let reader = new FileReader();
    reader.onloadend = function() {
      let img = document.getElementById('image-preview');
      img.src = reader.result;
      console.log(img.src);
    }
    reader.readAsDataURL(file);
  }

  let newBookFileInput = document.querySelector('.newBookFile');
  let BookFileName = document.querySelector('.BookFileName');

  newBookFileInput.addEventListener('change', function() {
    // 파일이 선택된 경우
    if (newBookFileInput.files.length > 0) {
      BookFileName.value = newBookFileInput.files[0].name;

    }
    // 파일이 선택되지 않은 경우
    else {
      alert('파일이 선택되지 않았습니다.');
    }
  });
</script>

</script>

<script>
  <!-- 북아이디값 가져오기 -->
  let bookId = document.querySelector('#bookId').value;

  <!-- 저장될 값 리스트 -->
<!--    let formData = new FormData();-->
<!--    let bookId = $("#bookId").val();-->
<!--    let isbn = $("#isbn").val();-->
<!--    let bookImgs = files[0];-->
<!--    let bookFiles = $("#bookFiles")[0].files[0];-->
<!--    -->
<!--    let bookTitle = $("#bookTitle").val();-->
<!--    let bookWriter = $("#bookWriter").val();-->
<!--    let store = $("#store").val();-->
<!--    let bookPub = $("#bookPub").val();-->
<!--    let bookPaperPrice = $("#bookPaperPrice").val();-->
<!--    let bookEbookPrice = $("#bookEbookPrice").val();-->
<!--    let bookCategory = $("#bookCategory").val();-->
<!--    let bookIntro = $("#bookIntro").val();-->
<!--    let bookIndex = $("#bookIndex").val();-->
<!--    let bookReview = $("#bookReview").val();-->
<!--    let bookWriterProfile = $("#bookWriterProfile").val();-->
<!--    let bookStatus = document.querySelector('input[name="bookStatus"]:checked').value;-->

  $(document).ready(function(){
    $(".book_add_form").on("submit", function(e){
      e.preventDefault(); // 기본 제출 동작 막기
      let formData = new FormData();
      let bookId = $("#bookId").val();
      let isbn = $("#isbn").val();
      <!-- 문제의 원인 -->
      let bookImgs = files[0];
      <!-- 문제의 원인 삼항연산자나 이프문으로 처리 -->
      let bookFiles = $("#bookFiles")[0].files[0];
      console.log(bookFiles);
      let bookTitle = $("#bookTitle").val();
      let bookWriter = $("#bookWriter").val();
      let store = $("#store").val();
      let bookPub = $("#bookPub").val();
      let bookPaperPrice = $("#bookPaperPrice").val();
      let bookEbookPrice = $("#bookEbookPrice").val();
      let bookCategory = $("#bookCategory").val();
      let bookIntro = $("#bookIntro").val();
      let bookIndex = $("#bookIndex").val();
      let bookReview = $("#bookReview").val();
      let bookWriterProfile = $("#bookWriterProfile").val();
      let bookStatus = document.querySelector('input[name="bookStatus"]:checked').value;

      let newBookFileInput = document.querySelector('.newBookFile');
      let BookFileName = document.querySelector('.BookFileName');
      // 이미지 + 파일 첨부 할 경우
      if(newBookFileInput.files.length > 0 && files.length > 0){
        alert("01번 타는코드");
        formData.append("bookId", bookId);
        formData.append("isbn", isbn);
        formData.append("bookImg", bookImgs);
        formData.append("bookFile", bookFiles);
        formData.append("bookTitle", bookTitle);
        formData.append("bookWriter", bookWriter);
        formData.append("store", store);
        formData.append("bookPub", bookPub);
        formData.append("bookPaperPrice", bookPaperPrice);
        formData.append("bookEbookPrice", bookEbookPrice);
        formData.append("bookCategory", bookCategory);
        formData.append("bookIntro", bookIntro);
        formData.append("bookIndex", bookIndex);
        formData.append("bookReview", bookReview);
        formData.append("bookWriterProfile", bookWriterProfile);
        formData.append("bookStatus", bookStatus);
        alert("이미지와 파일 모두 첨부하였음");
<!--        $.ajax({-->
<!--          type: "post",-->
<!--          url: '/cms/book/' + bookId + '/modify',-->
<!--          data: formData,-->
<!--          contentType: false,-->
<!--          processData: false,-->
<!--          success: function(result){-->
<!--            alert("도서가 수정되었습니다.");-->
<!--                console.log(result);-->
<!--                window.location.href = "/cms/book/list";-->
<!--            },-->
<!--          error: function(e) {-->
<!--              alert("도서수정이 실패하였습니다.");-->
<!--              console.log(e);-->
<!--          }-->
<!--        });-->
      }// 파일 첨부 없을 경우
      else if(!newBookFileInput.files.length && files.length > 0){
      alert("02번 타는코드");
        formData.append("bookId", bookId);
        formData.append("isbn", isbn);
        formData.append("bookImg", bookImgs);
        formData.append("bookTitle", bookTitle);
        formData.append("bookWriter", bookWriter);
        formData.append("store", store);
        formData.append("bookPub", bookPub);
        formData.append("bookPaperPrice", bookPaperPrice);
        formData.append("bookEbookPrice", bookEbookPrice);
        formData.append("bookCategory", bookCategory);
        formData.append("bookIntro", bookIntro);
        formData.append("bookIndex", bookIndex);
        formData.append("bookReview", bookReview);
        formData.append("bookWriterProfile", bookWriterProfile);
        formData.append("bookStatus", bookStatus);
        alert("이미지만 첨부하였음");
<!--        $.ajax({-->
<!--          type: "post",-->
<!--          url: '/cms/book/' + bookId + '/modify',-->
<!--          data: formData,-->
<!--          contentType: false,-->
<!--          processData: false,-->
<!--          success: function(result){-->
<!--            alert("도서가 수정되었습니다.");-->
<!--                console.log(result);-->
<!--                window.location.href = "/cms/book/list";-->
<!--            },-->
<!--          error: function(e) {-->
<!--              alert("도서수정이 실패하였습니다.");-->
<!--              console.log(e);-->
<!--          }-->
<!--        });-->
      }// 이미지 첨부 없을 경우
      else if(newBookFileInput.files.length > 0 && !files.length){
      alert("03번 타는코드");
        formData.append("bookId", bookId);
        formData.append("isbn", isbn);
        formData.append("bookFile", bookFiles);
        formData.append("bookTitle", bookTitle);
        formData.append("bookWriter", bookWriter);
        formData.append("store", store);
        formData.append("bookPub", bookPub);
        formData.append("bookPaperPrice", bookPaperPrice);
        formData.append("bookEbookPrice", bookEbookPrice);
        formData.append("bookCategory", bookCategory);
        formData.append("bookIntro", bookIntro);
        formData.append("bookIndex", bookIndex);
        formData.append("bookReview", bookReview);
        formData.append("bookWriterProfile", bookWriterProfile);
        formData.append("bookStatus", bookStatus);
        alert("파일 만 첨부하였음");
<!--        $.ajax({-->
<!--          type: "post",-->
<!--          url: '/cms/book/' + bookId + '/modify',-->
<!--          data: formData,-->
<!--          contentType: false,-->
<!--          processData: false,-->
<!--          success: function(result){-->
<!--            alert("도서가 수정되었습니다.");-->
<!--                console.log(result);-->
<!--                window.location.href = "/cms/book/list";-->
<!--            },-->
<!--          error: function(e) {-->
<!--              alert("도서수정이 실패하였습니다.");-->
<!--              console.log(e);-->
<!--          }-->
<!--        });-->
      }// 이미지 + 파일 첨부 없을 경우
      else{
      alert("04번 타는코드");
        formData.append("bookId", bookId);
        formData.append("isbn", isbn);
        formData.append("bookTitle", bookTitle);
        formData.append("bookWriter", bookWriter);
        formData.append("store", store);
        formData.append("bookPub", bookPub);
        formData.append("bookPaperPrice", bookPaperPrice);
        formData.append("bookEbookPrice", bookEbookPrice);
        formData.append("bookCategory", bookCategory);
        formData.append("bookIntro", bookIntro);
        formData.append("bookIndex", bookIndex);
        formData.append("bookReview", bookReview);
        formData.append("bookWriterProfile", bookWriterProfile);
        formData.append("bookStatus", bookStatus);
        alert("이미지와 파일 모두 첨부하지않음");
<!--        $.ajax({-->
<!--          type: "post",-->
<!--          url: '/cms/book/' + bookId + '/modify',-->
<!--          data: formData,-->
<!--          contentType: false,-->
<!--          processData: false,-->
<!--          success: function(result){-->
<!--            alert("도서가 수정되었습니다.");-->
<!--                console.log(result);-->
<!--                window.location.href = "/cms/book/list";-->
<!--            },-->
<!--          error: function(e) {-->
<!--              alert("도서수정이 실패하였습니다.");-->
<!--              console.log(e);-->
<!--          }-->
<!--          console.log(formData);-->
<!--        });-->
      }
    });
  });
</script>
</html>